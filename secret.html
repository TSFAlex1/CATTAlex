<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret — CATTAlex</title>
  <meta name="description" content="Secret link — CATTAlex" />
  <link rel="icon" href="CATTAlex pic2.png" type="image/png">
  <meta name="theme-color" content="#071022">

  <!-- Reuse the site's main stylesheet -->
  <link rel="stylesheet" href="styles.css">

  <!-- Modal-specific styles (keeps everything self-contained and compatible with styles.css) -->
  <style>
    /* Full-screen blurred backdrop (while modal active) */
    .secret-backdrop {
      position:fixed;
      inset:0;
      z-index:120;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(4,6,10,0.35);
      -webkit-backdrop-filter: blur(6px) saturate(1.1);
      backdrop-filter: blur(6px) saturate(1.1);
      pointer-events:auto;
    }

    .secret-modal {
      width: min(520px, 92%);
      background: linear-gradient(180deg, rgba(8,12,20,0.98), rgba(11,15,24,0.95));
      border: 1px solid rgba(255,255,255,0.06);
      padding: 22px;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      color: #e9f1ff;
      z-index:121;
    }

    .secret-modal h3 { margin:0 0 12px 0; font-family:Orbitron, Inter, sans-serif; color:var(--blue) }
    .secret-modal p { margin:8px 0; color:var(--muted) }

    .code-input {
      width:100%;
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .code-input input[type="text"]{
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: #fff;
      font-size:16px;
      letter-spacing:2px;
      text-align:center;
    }
    .code-input button{
      padding:10px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      background: linear-gradient(90deg,var(--red),var(--blue));
      color:#071022;
    }

    .secret-small {
      font-size:13px;color:var(--muted);margin-top:8px;
    }

    /* Disabled modal state (during lockout): dim button and input */
    .secret-modal.locked { opacity:0.9 }
    .secret-modal.locked input,
    .secret-modal.locked button { opacity:0.6; pointer-events:none }

    /* Simple non-blurred popup (for the bottom "reveal" button) */
    .plain-popup {
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      z-index:130;
      min-width:260px;
      max-width:90%;
      background: linear-gradient(180deg, rgba(10,14,22,0.99), rgba(8,12,20,0.95));
      border: 1px solid rgba(255,255,255,0.06);
      padding:18px;
      border-radius:12px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.6);
      color:#e9f1ff;
    }
    .plain-popup button{ margin-top:12px }

    /* Prevent pointer events on the page while backdrop is active */
    body.secret-locked *:not(.secret-backdrop):not(.secret-backdrop *):not(.plain-popup) {
      pointer-events: none;
      user-select: none;
    }

    /* Focus outline for accessibility */
    .secret-modal :focus { outline: 2px solid rgba(74,211,255,0.14); outline-offset:3px; }

  </style>
</head>
<body>
  <!-- Reuse background and decorative layers for consistent look -->
  <div class="bg-image" id="bgImage" aria-hidden="true"></div>
  <div class="scene-bg" aria-hidden="true">
    <div class="bg-layer layer--1"></div>
    <div class="bg-layer layer--2"></div>
    <div class="bg-layer layer--3"></div>
  </div>

  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <div class="avatar-wrap" aria-hidden="false">
          <img src="CATTAlex pic.jpg" alt="CATTAlex profile" class="avatar" id="avatar">
          <div class="neon-ring" aria-hidden="true"></div>
        </div>
        <div class="brand-text">
          <h1 class="channel-title">CATTAlex</h1>
          <p class="subtitle">Secret</p>
        </div>
      </div>

      <nav class="top-cta" aria-label="Primary">
        <a class="btn btn--glass" href="index.html">Back to Home</a>
      </nav>
    </div>
  </header>

  <main class="page" id="page" aria-hidden="false">
    <section class="panel panel--info" id="secret-panel">
      <div class="panel-inner">
        <h2>Secret Folder</h2>
        <p>Access the secret drive folder here:</p>
        <p><a class="btn btn--accent" id="secretLink" href="https://drive.google.com/drive/folders/1bb12p4kHvWDdIgvz047X4fAa9DKskguX?usp=sharing" target="_blank" rel="noopener noreferrer">Open Secret Drive Folder</a></p>

        <div style="margin-top:18px;">
          <a class="btn btn--ghost" href="index.html">Back to Home</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Blurred full-screen passcode modal (shown on page load unless unlocked) -->
  <div id="secretBackdrop" class="secret-backdrop" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="secretTitle">
    <div id="secretModal" class="secret-modal" role="document">
      <h3 id="secretTitle">Enter 4‑digit passcode</h3>
      <p class="secret-small">This area is restricted. Enter the correct 4-digit code to reveal the content.</p>

      <div class="code-input" role="group" aria-label="Passcode input">
        <input id="passInput" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off" aria-label="4 digit passcode" />
        <button id="passSubmit" type="button">Enter</button>
      </div>

      <div id="statusText" class="secret-small" aria-live="polite"></div>
    </div>
  </div>

  <!-- Plain popup (no blur) that reveals the code when user clicks the "reveal" button -->
  <div id="plainPopup" class="plain-popup" style="display:none;" role="dialog" aria-modal="false" aria-labelledby="plainTitle">
    <h4 id="plainTitle">Secret Code</h4>
    <p id="plainContent" style="font-weight:700; font-size:18px; letter-spacing:2px; margin-top:6px;"></p>
    <div style="text-align:right">
      <button id="plainClose" class="btn btn--glass">Close</button>
    </div>
  </div>

  <!-- Reveal button (bottom of the page) -->
  <div style="position:fixed; left:18px; bottom:18px; z-index:90;">
    <button id="revealBtn" class="btn btn--ghost">Reveal Code (popup)</button>
  </div>

  <script>
    (function(){
      // --- Simple obfuscation helpers (XOR + base64) ---
      // Not cryptographically secure, but the code is stored obfuscated so it's not visible as plain text in HTML.
      function b64ToBytes(b64){
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
        return bytes;
      }
      function bytesToStr(bytes){
        let s='';
        for(let i=0;i<bytes.length;i++) s += String.fromCharCode(bytes[i]);
        return s;
      }
      function xorDecryptBase64(b64, key){
        const data = b64ToBytes(b64);
        const keyBytes = new TextEncoder().encode(key);
        const out = new Uint8Array(data.length);
        for(let i=0;i<data.length;i++){
          out[i] = data[i] ^ keyBytes[i % keyBytes.length];
        }
        return bytesToStr(out);
      }

      // --- The "encrypted" secret stored as base64 of XOR(cipher) ---
      // We used a key of "abcd" to XOR "6381" and base64'd the result -> "U1FrVQ=="
      // At runtime we XOR back to obtain "6381".
      const encryptedSecret = "U1FrVQ==";
      // The XOR key is split into parts to avoid being trivially visible as one string in the markup.
      const keyParts = ["a", "b", "c", "d"];
      const xorKey = keyParts.join("");

      // Decrypt helper (returns plaintext code)
      function getSecretCode(){
        try{
          return xorDecryptBase64(encryptedSecret, xorKey);
        }catch(e){
          return null;
        }
      }

      // For the "plain popup" we also keep the display ciphertext separate (same encryptedSecret used).
      const plainPopupEncrypted = encryptedSecret;
      const plainPopupKeyParts = keyParts; // same key parts

      // --- UI elements ---
      const backdrop = document.getElementById('secretBackdrop');
      const modal = document.getElementById('secretModal');
      const passInput = document.getElementById('passInput');
      const passSubmit = document.getElementById('passSubmit');
      const statusText = document.getElementById('statusText');
      const page = document.getElementById('page');
      const revealBtn = document.getElementById('revealBtn');
      const plainPopup = document.getElementById('plainPopup');
      const plainContent = document.getElementById('plainContent');
      const plainClose = document.getElementById('plainClose');

      // --- Lockout / attempts logic stored in localStorage ---
      const LS_FAILED = 'secret_failed_attempts';
      const LS_LOCKUNTIL = 'secret_lock_until';
      const LOCK_THRESHOLD = 10;
      const LOCK_DURATION_MS = 2 * 60 * 1000; // 2 minutes

      function getFailedAttempts(){ return parseInt(localStorage.getItem(LS_FAILED) || '0',10) }
      function setFailedAttempts(n){ localStorage.setItem(LS_FAILED, String(n)); }
      function clearFailedAttempts(){ localStorage.removeItem(LS_FAILED); }

      function setLockUntil(ts){ localStorage.setItem(LS_LOCKUNTIL, String(ts)); }
      function getLockUntil(){ return parseInt(localStorage.getItem(LS_LOCKUNTIL) || '0',10); }
      function clearLockUntil(){ localStorage.removeItem(LS_LOCKUNTIL); }

      // Check lock state on load
      function isLockedNow(){
        const until = getLockUntil();
        return until && (Date.now() < until);
      }

      // Show the blurred modal (blocking)
      function showModalDisabled(message){
        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden','false');
        modal.classList.add('locked');
        document.body.classList.add('secret-locked');
        statusText.textContent = message || '';
        passInput.value = '';
      }

      // Show the normal modal (active)
      function showModal(message){
        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden','false');
        modal.classList.remove('locked');
        document.body.classList.add('secret-locked');
        statusText.textContent = message || '';
        passInput.focus();
      }

      function hideModal(){
        backdrop.style.display = 'none';
        backdrop.setAttribute('aria-hidden','true');
        document.body.classList.remove('secret-locked');
        statusText.textContent = '';
      }

      // If unlocked in this session, we won't show modal again. Use sessionStorage to remember.
      const SESSION_UNLOCKED = 'secret_unlocked_session';

      function markUnlocked(){
        sessionStorage.setItem(SESSION_UNLOCKED, '1');
        clearFailedAttempts();
        clearLockUntil();
      }
      function isSessionUnlocked(){ return sessionStorage.getItem(SESSION_UNLOCKED) === '1'; }

      // Handle wrong attempt increment, lock when threshold reached:
      function recordWrongAttempt(){
        let n = getFailedAttempts();
        n += 1;
        setFailedAttempts(n);
        if (n >= LOCK_THRESHOLD){
          // set lock and redirect to index.html immediately
          const until = Date.now() + LOCK_DURATION_MS;
          setLockUntil(until);
          // immediate redirect as requested
          window.location.href = 'index.html';
        } else {
          statusText.textContent = `Incorrect code — ${LOCK_THRESHOLD - n} attempts remaining.`;
        }
      }

      // Update countdown timer when locked
      let countdownTimer = null;
      function startLockCountdown(){
        const until = getLockUntil();
        if (!until || Date.now() >= until) {
          clearLockUntil();
          clearFailedAttempts();
          return showModal(); // now allow input
        }
        showModalDisabled('');
        function tick(){
          const now = Date.now();
          const rem = until - now;
          if (rem <= 0){
            clearLockUntil();
            clearFailedAttempts();
            clearInterval(countdownTimer);
            countdownTimer = null;
            showModal();
            return;
          }
          const s = Math.ceil(rem / 1000);
          statusText.textContent = `Too many incorrect attempts. Try again in ${s} second${s===1?'':'s'}.`;
        }
        tick();
        countdownTimer = setInterval(tick, 1000);
      }

      // On submit: decrypt secret and compare
      passSubmit.addEventListener('click', function(e){
        const val = (passInput.value || '').trim();
        if (!/^\d{4}$/.test(val)){
          statusText.textContent = 'Enter a 4-digit numeric code.';
          return;
        }
        const secret = getSecretCode();
        if (secret === null){
          statusText.textContent = 'Internal error — cannot verify code.';
          return;
        }
        if (val === secret){
          // success
          markUnlocked();
          hideModal();
        } else {
          recordWrongAttempt();
          passInput.value = '';
          passInput.focus();
        }
      });

      // Enter key handling
      passInput.addEventListener('keydown', function(e){
        if (e.key === 'Enter'){
          e.preventDefault();
          passSubmit.click();
        }
        // prevent tabbing out of the input to the page while modal active
        if (e.key === 'Tab'){
          e.preventDefault();
        }
      });

      // Prevent clicks on backdrop from closing or focusing other parts
      backdrop.addEventListener('click', function(e){
        // If clicked outside modal, keep focus in input; do nothing.
        if (!modal.contains(e.target)){
          e.stopPropagation();
          passInput.focus();
        }
      });

      // Trap focus inside modal while shown
      window.addEventListener('focus', function(){
        if (backdrop.style.display === 'flex' && !isSessionUnlocked()){
          passInput.focus();
        }
      }, true);

      // Plain popup reveal button
      revealBtn.addEventListener('click', function(){
        // decrypt and show the secret in the plain non-blurred popup
        try{
          const key = plainPopupKeyParts.join('');
          const code = xorDecryptBase64(plainPopupEncrypted, key);
          plainContent.textContent = code; // displayed in bold via CSS
          plainPopup.style.display = 'block';
          plainClose.focus();
        }catch(e){
          plainContent.textContent = 'Error';
          plainPopup.style.display = 'block';
        }
      });
      plainClose.addEventListener('click', function(){
        plainPopup.style.display = 'none';
      });

      // On page load: if session unlocked, do not show modal.
      // Otherwise check lock state and show modal or locked message.
      window.addEventListener('load', function(){
        // If user is already unlocked this session, skip modal.
        if (isSessionUnlocked()){
          // ensure backdrop hidden and page interactive
          hideModal();
          return;
        }

        // If lock active, start the countdown and show disabled modal.
        if (isLockedNow()){
          startLockCountdown();
        } else {
          // show normal modal
          showModal();
        }

        // Prevent scrolling while modal present
        document.addEventListener('touchmove', function(e){
          if (document.body.classList.contains('secret-locked')) e.preventDefault();
        }, { passive:false });

        // Make sure secretLink is disabled until unlocked
        const secretLink = document.getElementById('secretLink');
        if (!isSessionUnlocked()){
          // prevent navigation until unlocked
          secretLink.addEventListener('click', function(e){
            if (!isSessionUnlocked()){
              e.preventDefault();
              passInput.focus();
              statusText.textContent = 'Enter the passcode to access this link.';
            }
          });
        }
      });

      // Extra: if user navigates back after a lock (lock was set before redirect),
      // the countdown will show and prevent attempts until elapsed (handled above).
    })();
  </script>
</body>
</html>
